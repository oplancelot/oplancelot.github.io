I"cP<p>If you are already familiar with Cap’n Proto and just want to see how to use it with Python click <a href="#capnpwithpython">here</a>.</p>
<h2 id="introduction-to-capn-proto">Introduction to Cap’n Proto</h2>
<p>Ever heard of Cap’n Proto? - No it’s not one of the worst named superheroes ever. Lets have a look at what the <a href="https://capnproto.org">official webpage</a> is saying:</p>

<p><em>Cap’n Proto is an insanely fast data interchange format and capability-based RPC system.</em></p>

<p>This addresses two points - <strong>data interchange format</strong> and <strong>RPC</strong>. But before we can make use of whatever this means we will have a look at Cap’n Proto’s schema language.</p>
<h3 id="schema-language">Schema language</h3>
<p>This language is used to define structures for further use. It’s syntax shows similarities to the C programming language and supports common data types like Boolean, Integer, Struct, Enum, etc.
Let’s have a look at it:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">const blogUrl :Text = "brennerm.github.io/"; 

enum Language {
	en @0;
	de @1;
	ru @2;
}

struct Date{
	year @0 :Int16;
	month @1 :UInt8;
	day @2 :UInt8;
}

struct Post {
	availableLanguages @0 :List(Language);
	publishDate @1 :Date;
	content @2 :Text;
}</code></pre></figure>

<p>As you see containers like <em>struct</em> or <em>enum</em> are supported and can be used to easily abstract real-world objects.</p>

<p>You may have already noticed the numbers behind every single field. This enables Cap’n Proto to keep your evolving schema backwards compatible. As long as you follow <a href="https://capnproto.org/language.html#evolving-your-protocol">some rules</a> there is no need to spend time on keeping your application compatible with older versions.</p>

<p>There’s no point going over the whole vocabulary of the schema language. It’s just important to get a basic understanding, cause the following features use this schemas as a basis. If you want to learn more about the schema language have a look <a href="https://capnproto.org/language.html">here</a>.</p>
<h3 id="data-interchange-format">data interchange format</h3>
<p>The data interchange format is based on messages that can contain multiple instances of our self-defined objects. These messages are saved in a binary format which is controlled by the Cap’n Proto library.</p>

<p>Each data type is handled in a <a href="https://capnproto.org/encoding.html#value-encoding">defined way</a> which results in a well organized format.
For bandwidth limited use cases Cap’n Proto provides a built-in packing that can save up a lot of unnecessary zero bytes. In some cases the size can be shrunk further by applying a suitable compression algorithm.</p>
<h3 id="rpc">RPC</h3>
<p>RPC stands for <strong>remote procedure call</strong> which is a type of inter-process communication. It allows you to call functions that are provided by another process on your machine or even over the network.</p>

<p>It follows the client-server-architecture with the server providing and executing the functions and the clients calling them. The interface definition is handled through the schema language we discussed earlier:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">interface Calc {
	sum @0 (a :Int64, b :Int64) -&gt; (result :Int64);
	sub @1 (a :Int64, b :Int64) -&gt; (result :Int64);
	mul @2 (a :Int64, b :Int64) -&gt; (result :Int64);
	div @3 (a :Int64, b :Int64) -&gt; (result :Float64);
}</code></pre></figure>

<p>This is an example of a really basic calculator, but contains all you need to know. It’s of course possible to use your own defined structures as parameters or return value.</p>

<p>There are already several implementations of RPC like Java’s RMI, CORBA or DBUS, but Cap’n Proto provides a feature called <strong>promise pipelining</strong>. This lets you use a return value of one function call as an argument for another without waiting for the first function to finish. This is especially useful when your application runs in an environment with a long round trip time, cause you save up unnecessary requests. More information can be found <a href="https://capnproto.org/rpc.html#time-travel-promise-pipelining">here</a>.
<a name="capnpwithpython"></a></p>
<h2 id="capn-proto-with-python">Cap’n Proto with Python</h2>
<p>With the knowledge of what Cap’n Proto is all about we’ll have a look into <a href="https://github.com/jparyani/pycapnp">pycapnp</a>. It’s a wrapper for Cap’n Proto that makes most of the features available to use with Python. The following examples will be based on this schema:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">enum Unit {
	k @0;
	f @1;
	c @2;
}

struct Temperature {
	value @0 :Float64;
	unit @1 :Unit;
}

interface TempConv {
	convert @0 (temp :Temperature, target_unit :Unit) -&gt; (result :Temperature);
}</code></pre></figure>

<h3 id="message-creation">Message creation</h3>
<p>Before we are able to create our messages we need to read in our schema. Pycapnp handles this pretty <em>pythonic</em>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">capnp</span>
<span class="kn">import</span> <span class="nn">tempconv_capnp</span></code></pre></figure>

<p>This will search the current directory and your <em>PYTHONPATH</em> for a file called <em>tempconv.capnp</em>. The schema is going to be processed and made accessible like a module within your code. You can then create and define your messages like that:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">temp</span> <span class="o">=</span> <span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">Temperature</span><span class="p">.</span><span class="n">new_message</span><span class="p">()</span>

<span class="n">temp</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">temp</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s">'c'</span>
<span class="k">print</span><span class="p">(</span><span class="s">'temperature:'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span></code></pre></figure>

<p>Pretty easy, right? Pycapnp handles all validation and errors are raised when a value is inappropriate (type mismatch, not in enum, …).</p>

<p>If you like dicts, this is a way you can go:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">temp_dict</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">restored_temp</span> <span class="o">=</span> <span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">Temperature</span><span class="p">.</span><span class="n">new_message</span><span class="p">(</span><span class="o">**</span><span class="n">temp_dict</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'temperature:'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">restored_temp</span><span class="p">))</span></code></pre></figure>

<h3 id="de-serialization">De-/Serialization</h3>
<p>The de- and serialization from and to the data interchange format is supported as well:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">capnp</span>
<span class="kn">import</span> <span class="nn">tempconv_capnp</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">Temperature</span><span class="p">.</span><span class="n">new_message</span><span class="p">()</span>

<span class="n">temp</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">temp</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s">'c'</span>
<span class="k">print</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

<span class="n">temp_bytes</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">temp_bytes</span><span class="p">)</span>

<span class="n">restored_temp</span> <span class="o">=</span> <span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">Temperature</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">temp_bytes</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">restored_temp</span><span class="p">)</span></code></pre></figure>

<p>The resulting bytes can be send over the network or can be saved in a file.
To use Cap’n Proto’s built-in packing just append <em>_packed</em> to <em>to_bytes</em> and <em>from_bytes</em>.</p>
<h3 id="rpc-1">RPC</h3>
<p>Let’s come to the most interesting part of the library. Our target is to build a server that offers and executes the <em>convert</em> function. The functionality is implemented like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># name of the class doesn't matter, as long as you inherit from your server class
</span><span class="k">class</span> <span class="nc">TempConv</span><span class="p">(</span><span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">TempConv</span><span class="p">.</span><span class="n">Server</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">target_unit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span>
		
		<span class="n">result</span> <span class="o">=</span> <span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">Temperature</span><span class="p">.</span><span class="n">new_message</span><span class="p">()</span>
        <span class="n">result</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">target_unit</span>
        <span class="n">result</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">CONVERTER</span><span class="p">[</span><span class="n">temp_dict</span><span class="p">[</span><span class="s">'unit'</span><span class="p">]][</span><span class="nb">str</span><span class="p">(</span><span class="n">target_unit</span><span class="p">)](</span><span class="n">temp_dict</span><span class="p">[</span><span class="s">'value'</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span></code></pre></figure>

<p>Be sure to name your function according to your interface definition and add <em>**kwargs</em> to your parameters. This will ensure your server remains compatible with newer versions that may provide more arguments.</p>

<p>Now it’s time to start our server:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># enables you to save capabilities and restore them later
</span><span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">ref</span><span class="p">.</span><span class="n">as_text</span><span class="p">()</span> <span class="o">==</span> <span class="s">'tempConv'</span>
    <span class="k">return</span> <span class="n">TempConv</span><span class="p">()</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">capnp</span><span class="p">.</span><span class="n">TwoPartyServer</span><span class="p">(</span><span class="s">'127.0.0.1:12345'</span><span class="p">,</span> <span class="n">restore</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="n">run_forever</span><span class="p">()</span></code></pre></figure>

<p>With the server up and running we can now connect our client:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">client</span> <span class="o">=</span> <span class="n">capnp</span><span class="p">.</span><span class="n">TwoPartyClient</span><span class="p">(</span><span class="s">'localhost:12345'</span><span class="p">)</span>

<span class="n">tempconv</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">ez_restore</span><span class="p">(</span><span class="s">'tempConv'</span><span class="p">).</span><span class="n">cast_as</span><span class="p">(</span><span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">TempConv</span><span class="p">)</span></code></pre></figure>

<p>With the connection in hand we can finally call our <em>convert</em> function:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">request</span> <span class="o">=</span> <span class="n">tempconv</span><span class="p">.</span><span class="n">convert_request</span><span class="p">()</span>

<span class="n">request</span><span class="p">.</span><span class="n">temp</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">request</span><span class="p">.</span><span class="n">temp</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s">'c'</span>
<span class="n">request</span><span class="p">.</span><span class="n">target_unit</span> <span class="o">=</span> <span class="s">'k'</span>

<span class="n">promise</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">send</span><span class="p">()</span></code></pre></figure>

<p>The resulting promise can be handled in two ways:</p>

<ul>
  <li>asynchronous:</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">promise</span><span class="p">.</span><span class="n">then</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ret</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="n">ret</span><span class="p">)).</span><span class="n">wait</span><span class="p">()</span></code></pre></figure>

<ul>
  <li>synchronous:</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">result</span> <span class="o">=</span> <span class="n">promise</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span></code></pre></figure>

<p>And there is our result:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">(</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mf">373.15</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span> <span class="p">)</span></code></pre></figure>

<p>That’s all you need to know for now to make use of Cap’n Proto for your Python application. When having a look at the <a href="https://capnproto.org/roadmap.html">roadmap</a> there will be some interesting features in the future, like <em>shared-memory RPC</em> or <em>dynamic schema transmission</em> so stay tuned for updates.
<br />All shown code examples can be found on <a href="https://github.com/brennerm/brennerm.github.io/tree/master/_posts/capnproto_with_python">github</a>.</p>

<p>#Update 20.05.2015
Played around using my own sockets when communicating with pycapnp’s RPC lately and had some trouble in the beginning. So I just want to let you guys know how to get it working.
The first step is to connect your client and server socket:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># server
</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">12345</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>

<span class="c1"># client
</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">12345</span><span class="p">))</span></code></pre></figure>

<p>Now instead of handing over the address + port hand over your socket to the server and client constructor.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># server
</span><span class="n">server</span> <span class="o">=</span> <span class="n">capnp</span><span class="p">.</span><span class="n">TwoPartyServer</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="n">TempConv</span><span class="p">())</span>
<span class="n">server</span><span class="p">.</span><span class="n">on_disconnect</span><span class="p">().</span><span class="n">wait</span><span class="p">()</span>

<span class="c1"># client
</span><span class="n">client</span> <span class="o">=</span> <span class="n">capnp</span><span class="p">.</span><span class="n">TwoPartyClient</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">tempconv</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">bootstrap</span><span class="p">().</span><span class="n">cast_as</span><span class="p">(</span><span class="n">tempconv_capnp</span><span class="p">.</span><span class="n">TempConv</span><span class="p">)</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">tempconv</span><span class="p">.</span><span class="n">convert_request</span><span class="p">()</span>

<span class="n">request</span><span class="p">.</span><span class="n">temp</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">request</span><span class="p">.</span><span class="n">temp</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s">'c'</span>
<span class="n">request</span><span class="p">.</span><span class="n">target_unit</span> <span class="o">=</span> <span class="s">'k'</span>

<span class="n">promise</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="p">.</span><span class="n">wait</span><span class="p">())</span></code></pre></figure>

<p>Be sure to use <em>server.on_disconnect().wait()</em> instead of <em>server.run_forever()</em> and it will work as expected.</p>
:ET