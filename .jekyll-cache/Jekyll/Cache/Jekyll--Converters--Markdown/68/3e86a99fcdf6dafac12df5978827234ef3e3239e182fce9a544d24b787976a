I"æ0<h2 id="introduction">Introduction</h2>
<p>AWSâ€™ IAM service is a powerful system to provide fine-grained control over AWS resources. Additionally it is integrated into several AWS services and EKS is no exception. Next to the cluster role, <a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">AWS introduced 2019</a> the concept of IRSA, which stands for IAM Roles for Service Accounts.</p>

<p>Together with Kubernetesâ€™ RBAC system it allows to assign IAM role capabilities to K8s computing resources like <em>Pods</em> and <em>Jobs</em>. A simple use case you can imagine is allowing a Pod to write to a S3 bucket. After reading through this blog post you will understand how to create an EKS cluster using Terraform with IRSA support and how to make use of it.</p>

<h2 id="preparing-the-vpc">Preparing the VPC</h2>
<p>Before creating an EKS cluster you need to set up a VPC network that your data and control plane traffic can go through. It will also define whether your Kubernetes API endpoint will be accessible publicly or only from within a private network.</p>

<p>Depending on your requirements the VPC configuration can be more or less complex. If you donâ€™t want to do anything too crazy I suggest to use <a href="https://github.com/terraform-aws-modules/terraform-aws-vpc"><em>aws-vpc</em></a> module. It provides a nice abstraction layer for the AWS VPC Terraform resources that are being used under the hood. Below you can find an example VPC configuration that can act as a starting point for your EKS.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span> <span class="s2">"vpc"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"terraform-aws-modules/vpc/aws"</span>

  <span class="nx">name</span>                 <span class="p">=</span> <span class="s2">"my-vpc"</span>
  <span class="nx">cidr</span>                 <span class="p">=</span> <span class="s2">"10.0.0.0/16"</span>
  <span class="nx">azs</span>                  <span class="p">=</span> <span class="p">[</span><span class="s2">"eu-central-1a"</span><span class="p">,</span> <span class="s2">"eu-central-1b"</span><span class="p">,</span> <span class="s2">"eu-central-1c"</span><span class="p">]</span>
  <span class="nx">public_subnets</span>       <span class="p">=</span> <span class="p">[</span><span class="s2">"10.0.1.0/24"</span><span class="p">,</span> <span class="s2">"10.0.2.0/24"</span><span class="p">,</span> <span class="s2">"10.0.3.0/24"</span><span class="p">]</span>
  <span class="nx">enable_dns_support</span>   <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">enable_dns_hostnames</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Be aware that an EKS cluster needs at least two subnets in different availability zones. Enabling the DNS related flags is necessary to allow the worker nodes to find and register themselves at the API server.</p>

<h2 id="creating-the-eks-cluster">Creating the EKS cluster</h2>
<p>Similar to the VPC, I recommend you to use the <a href="https://github.com/terraform-aws-modules/terraform-aws-eks"><em>aws-eks</em></a> Terraform module if your EKS setup is not too far away from the ordinary.
Below you can find an example Terraform code snippet that uses the previously discussed VPC.</p>
<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span> <span class="s2">"cluster"</span> <span class="p">{</span>
  <span class="nx">source</span>          <span class="p">=</span> <span class="s2">"terraform-aws-modules/eks/aws"</span>
  <span class="nx">cluster_name</span>    <span class="p">=</span> <span class="s2">"cluster"</span>
  <span class="nx">cluster_version</span> <span class="p">=</span> <span class="s2">"1.18"</span>
  <span class="nx">vpc_id</span>          <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">vpc_id</span>
  <span class="nx">subnets</span>         <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">vpc_subnet_ids</span>
  <span class="nx">enable_irsa</span>     <span class="p">=</span> <span class="kc">true</span>

  <span class="nx">worker_groups</span> <span class="p">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">instance_type</span> <span class="p">=</span> <span class="s2">"t3.medium"</span>
      <span class="nx">asg_max_size</span>  <span class="p">=</span> <span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <em>enable_irsa</em> flag will lead to the OIDC (OpenID Connect) provider being created. Additionally we will define a Terraform output that contains its ARN (Amazon Resource Name) which will be used in the next step.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">output</span> <span class="s2">"oidc_provider_arn"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">cluster</span><span class="err">.</span><span class="nx">oidc_provider_arn</span>
<span class="p">}</span>
</code></pre></div></div>
<p>And thatâ€™s all you need to continue with the next step.</p>

<h2 id="creating-a-service-account-associated-with-an-iam-role">Creating a service account associated with an IAM role</h2>
<p>In this example we are going to create a service account that has full access to all of your S3 buckets. This can be easily changed by adjusting the policies that you attach to your IAM role.</p>

<p>To start with we need to define a few variables.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ROLE_NAME</span><span class="o">=</span>s3-writer <span class="c"># the name of your IAM role</span>
<span class="nv">SERVICE_ACCOUNT_NAME</span><span class="o">=</span>s3-writer <span class="c"># the name of your service account name</span>
<span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="o">=</span>default <span class="c"># the namespace for your service account</span>
<span class="nv">PROVIDER_ARN</span><span class="o">=</span><span class="si">$(</span>terraform output <span class="nt">-json</span> | jq <span class="nt">-r</span> .oidc_provider_arn.value<span class="si">)</span> <span class="c"># the ARN of your OIDC provider</span>
<span class="nv">ISSUER_HOSTPATH</span><span class="o">=</span><span class="si">$(</span>aws eks describe-cluster <span class="nt">--name</span> cluster <span class="nt">--query</span> cluster.identity.oidc.issuer <span class="nt">--output</span> text | <span class="nb">cut</span> <span class="nt">-f</span> 3- <span class="nt">-d</span><span class="s1">'/'</span><span class="si">)</span> <span class="c"># the host path of your OIDC issuer</span>
</code></pre></div></div>

<p>The most important step is defining the correct assume policy for your IAM role.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> assume-policy.json <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "</span><span class="nv">$PROVIDER_ARN</span><span class="sh">"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "</span><span class="k">${</span><span class="nv">ISSUER_HOSTPATH</span><span class="k">}</span><span class="sh">:sub": "system:serviceaccount:</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">SERVICE_ACCOUNT_NAME</span><span class="k">}</span><span class="sh">"
        }
      }
    }
  ]
}
</span><span class="no">EOF
</span></code></pre></div></div>
<p>This will allow the service account to switch to your role using the <em>AssumeRoleWithWebIdentity</em> command.</p>

<p>Afterwards you can create the new role using the above assume policy and attach your desired policies to it.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws iam create-role <span class="nt">--role-name</span> <span class="nv">$ROLE_NAME</span> <span class="nt">--assume-role-policy-document</span> file://assume-policy.json
<span class="nv">$ </span>aws iam update-assume-role-policy <span class="nt">--role-name</span> <span class="nv">$ROLE_NAME</span> <span class="nt">--policy-document</span> file://assume-policy.json
<span class="nv">$ </span>aws iam attach-role-policy <span class="nt">--role-name</span> <span class="nv">$ROLE_NAME</span> <span class="nt">--policy-arn</span> arn:aws:iam::aws:policy/AmazonS3FullAccess
</code></pre></div></div>

<p>The last step is to create the Kubernetes Service Account and annotate it with the role ARN.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create sa <span class="nv">$SERVICE_ACCOUNT_NAME</span>
<span class="nv">$ S3_ROLE_ARN</span><span class="o">=</span><span class="si">$(</span>aws iam get-role <span class="nt">--role-name</span> <span class="nv">$ROLE_NAME</span> <span class="nt">--query</span> Role.Arn <span class="nt">--output</span> text<span class="si">)</span>
<span class="nv">$ </span>kubectl annotate sa <span class="nv">$SERVICE_ACCOUNT_NAME</span> eks.amazonaws.com/role-arn<span class="o">=</span><span class="nv">$S3_ROLE_ARN</span>
</code></pre></div></div>

<h2 id="using-the-service-account-in-your-application">Using the service account in your application</h2>
<p>Assigning the newly created service account to your application only requires adding a single line to your <em>Deployment</em> or <em>Job</em> manifest.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">template</span><span class="err">:</span>
    <span class="s">...</span>
    <span class="s">spec</span><span class="err">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">s3-writer</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">myapp:latest</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="s">...</span>
</code></pre></div></div>

<p>This will result in the <a href="https://github.com/aws/amazon-eks-pod-identity-webhook/">EKS Pod Identity Webhook</a> injecting some environment variables and a volume mount into each of your pods that contain the access credentials for your IAM role. If you use a recent version of the <a href="https://aws.amazon.com/tools/">AWS SDK</a> these will be picked up automatically when creating a new session and you are good to go.</p>

<p>As a conclusion you can find an overview of all components and processes being part of the IRSA concept below.</p>
<figure class="image">
  <img src="https://d2908q01vomqb2.cloudfront.net/ca3512f4dfa95a03169c5a670a4c91a19b3077b4/2019/08/12/irp-eks-setup-1024x1015.png" alt="Overview of IRSA components and processes" loading="lazy" />
  <figcaption>
    Overview of IRSA components and processes
    
    / <a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">image source</a>
    
  </figcaption>
</figure>

<p>For further details check out <a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">the official AWS blog post about IRSA</a>.</p>

<hr />
:ET